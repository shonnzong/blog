<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ShonnZong的博客</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://140.143.243.43/"/>
  <updated>2019-02-16T18:42:46.477Z</updated>
  <id>http://140.143.243.43/</id>
  
  <author>
    <name>ShonnZong</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Workerman安装使用</title>
    <link href="http://140.143.243.43/2019/02/17/Workerman%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/"/>
    <id>http://140.143.243.43/2019/02/17/Workerman安装使用/</id>
    <published>2019-02-16T18:07:37.000Z</published>
    <updated>2019-02-16T18:42:46.477Z</updated>
    
    <content type="html"><![CDATA[<h3 id="安装说明"><a href="#安装说明" class="headerlink" title="安装说明"></a>安装说明</h3><p>WorkerMan实际上就是一个PHP代码包，如果你的PHP环境已经装好，只需要把WorkerMan源代码或者demo下载下来即可运行。</p><h3 id="windows用户（必读）"><a href="#windows用户（必读）" class="headerlink" title="windows用户（必读）"></a>windows用户（必读）</h3><p>windows用户需要使用windows版本的workerman，windows版本workerman本身不依赖任何扩展，只需要配置好PHP环境变量即可，windows版本workerman安装及注意事项参见<a href="https://www.workerman.net/windows" target="_blank" rel="noopener">windows用户必看</a>。</p><h3 id="Linux系统环境检测"><a href="#Linux系统环境检测" class="headerlink" title="Linux系统环境检测"></a>Linux系统环境检测</h3><p>Linux系统可以使用以下脚本测试本机PHP环境是否满足WorkerMan运行要求。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -Ss http://www.workerman.net/check.php | php</span><br></pre></td></tr></table></figure><p>上面脚本如果全部显示ok，则代表满足WorkerMan要求，直接到官网下载例子即可运行。<br>如果不是全部ok，则参考下面文档安装缺失的扩展即可。<br>若出现Function stream_socket_server may be disabled. Please check disable_functions in php.ini<br>see <a href="http://doc3.workerman.net/faq/disable-function-check.html" target="_blank" rel="noopener">http://doc3.workerman.net/faq/disable-function-check.html</a><br>这里以lnmp集成安装包为例修改php.ini</p><p>修改PHP配置文件:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/<span class="built_in">local</span>/php/etc/php.ini</span><br><span class="line"><span class="comment">#去除disable_functions 后面的 stream_socket_server</span></span><br></pre></td></tr></table></figure><p>（注意：检测脚本中没有检测event扩展或者libevent扩展，如果业务并发连接数大于1024建议安装event扩展或者libevent扩展，安装方法参照下面说明）</p><h3 id="已有PHP环境安装缺失扩展"><a href="#已有PHP环境安装缺失扩展" class="headerlink" title="已有PHP环境安装缺失扩展"></a>已有PHP环境安装缺失扩展</h3><p>1.<strong>安装pcntl和posix扩展：</strong></p><p><strong>centos系统</strong><br>如果php是通过yum安装的，则命令行运行 yum install php-process即可安装pcntl和posix扩展。</p><p>2.<strong>安装event或者libevent扩展：</strong></p><p>为了能支持更大的并发连接数，建议安装event扩展或者libevent扩展(二者作用相同，二选一即可)。以Event为例，安装方法如下:</p><p><strong>centos系统</strong></p><p>a.安装event扩展依赖的libevent-devel包，命令行运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install libevent-devel -y</span><br></pre></td></tr></table></figure><p>b.安装event扩展，命令行运行<br>(event扩展要求PHP&gt;=5.4，PHP5.3用户请安装libevent扩展(libevent扩展同时支持php5.4-5.6)，见本页面底部)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pecl install event</span><br></pre></td></tr></table></figure><p>注意提示：Include libevent OpenSSL support [yes] : 时输入no回车，其它直接敲回车就行<br>如果安装失败请跳过以下步骤，尝试安装libevent扩展，见本页面底部。</p><p>c.命令行运行（如果ini文件位置不对，可以通过运行php –ini找到实际加载的ini文件路径）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> extension=event.so &gt; /etc/php.d/30-event.ini 这里若是lnmp集成安装包写/usr/<span class="built_in">local</span>/php/etc/php.ini</span><br></pre></td></tr></table></figure><p>More info: <a href="http://doc.workerman.net/315116" target="_blank" rel="noopener">GO</a></p><h3 id="GatewayWorker安装"><a href="#GatewayWorker安装" class="headerlink" title="GatewayWorker安装"></a>GatewayWorker安装</h3><p><strong>Linux版安装</strong></p><p>a、进入thinkphp5的目录，例cd /home/wwwroot/house.nbdeli.net/house，使用composer require workerman/gateway-worker 安装Linux版本的gateway<br>b、去官网下载Linux版的gateway-worker，里面有demo。 <a href="http://www.workerman.net/download" target="_blank" rel="noopener">http://www.workerman.net/download</a><br>c、将下载的压缩包解压，将Applications/Yourapp中的文件全部复制到thinkphp5目录application里面的任意文件夹，这里取名为push<br>d、将解压后的文件夹中的start.php复制到thinkphp5的根目录，即与application同级的目录<br>e、将start.php文件中最后部分forearch循环括号内的路径改为自己的正确路径<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__DIR__.<span class="string">'/application/push/start*.php'</span></span><br></pre></td></tr></table></figure></p><p>f、在命令行php start.php start 启动</p><p>以debug（调试）方式启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php start.php start</span><br></pre></td></tr></table></figure></p><p>以daemon（守护进程）方式启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php start.php start -d</span><br></pre></td></tr></table></figure></p><p>停止<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php start.php stop</span><br></pre></td></tr></table></figure></p><p>重启<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php start.php restart</span><br></pre></td></tr></table></figure></p><p>平滑重启<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php start.php reload</span><br></pre></td></tr></table></figure></p><p>查看状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php start.php status</span><br></pre></td></tr></table></figure></p><p>查看连接状态（需要Workerman版本&gt;=3.5.0<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php start.php connections</span><br></pre></td></tr></table></figure></p><p>More info: <a href="https://www.cnblogs.com/wt645631686/p/7219519.html" target="_blank" rel="noopener">GO</a></p><h3 id="Workerman-MySQL"><a href="#Workerman-MySQL" class="headerlink" title="Workerman/MySQL"></a>Workerman/MySQL</h3><h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><p>常驻内存的程序在使用mysql时经常会遇到mysql gone away的错误，这个是由于程序与mysql的连接长时间没有通讯，连接被mysql服务端踢掉导致。本数据库类可以解决这个问题，当发生mysql gone away错误时，会自动重试一次。</p><h4 id="依赖的扩展"><a href="#依赖的扩展" class="headerlink" title="依赖的扩展"></a>依赖的扩展</h4><p>该mysql类依赖pdo和pdo_mysql两个扩展，缺少扩展会报Undefined class constant ‘MYSQL_ATTR_INIT_COMMAND’ in ….错误。<br>命令行运行php -m会列出所有php cli已安装的扩展，如果没有pdo 或者 pdo_mysql，请自行安装。</p><p><strong>centos系统</strong><br>PHP5.x</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install php-pdo</span><br><span class="line">yum install php-mysql</span><br></pre></td></tr></table></figure><p>PHP7.x</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install php70w-pdo_dblib.x86_64</span><br><span class="line">yum install php70w-mysqlnd.x86_64</span><br></pre></td></tr></table></figure><p>如果找不到包名，请尝试用yum search php mysql查找</p><p>1、<strong>安装 Workerman/MySQL</strong><br><strong>方法1：</strong><br>可以通过composer安装，命令行运行以下命令(composer源在国外，安装过程可能会非常慢)。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require workerman/mysql</span><br></pre></td></tr></table></figure></p><p>上面命令成功后会生成vendor目录，然后在项目中引入vendor下的autoload.php。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require_once __DIR__ . <span class="string">'/vendor/autoload.php'</span>;</span><br></pre></td></tr></table></figure></p><p><strong>方法2：</strong><br><a href="https://github.com/walkor/mysql/archive/master.zip" target="_blank" rel="noopener">下载源码</a>，解压后的目录放到自己项目中(位置任意)，直接require源文件。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require_once <span class="string">'/your/path/of/mysql-master/src/Connection.php'</span>;</span><br></pre></td></tr></table></figure></p><p><strong>注意</strong><br>强烈建议在onWorkerStart回调中初始化数据库连接，避免在Worker::runAll();运行前就初始化连接，在Worker::runAll();运行前初始化的连接属于主进程，子进程会继承这个连接，主进程和子进程共用相同的数据库连接会导致错误。<br>示例<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">use Workerman\Worker;</span><br><span class="line">require_once __DIR__ . <span class="string">'/Workerman/Autoloader.php'</span>;</span><br><span class="line">require_once __DIR__ . <span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"><span class="variable">$worker</span> = new Worker(<span class="string">'websocket://0.0.0.0:8484'</span>);</span><br><span class="line"><span class="variable">$worker</span>-&gt;onWorkerStart = <span class="keyword">function</span>(<span class="variable">$worker</span>)</span><br><span class="line">&#123;</span><br><span class="line">    // 将db实例存储在全局变量中(也可以存储在某类的静态成员中)</span><br><span class="line">    global <span class="variable">$db</span>;</span><br><span class="line">    <span class="variable">$db</span> = new \Workerman\MySQL\Connection(<span class="string">'host'</span>, <span class="string">'port'</span>, <span class="string">'user'</span>, <span class="string">'password'</span>, <span class="string">'db_name'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="variable">$worker</span>-&gt;onMessage = <span class="keyword">function</span>(<span class="variable">$connection</span>, <span class="variable">$data</span>)</span><br><span class="line">&#123;</span><br><span class="line">    // 通过全局变量获得db实例</span><br><span class="line">    global <span class="variable">$db</span>;</span><br><span class="line">    // 执行SQL</span><br><span class="line">    <span class="variable">$all_tables</span> = <span class="variable">$db</span>-&gt;query(<span class="string">'show tables'</span>);</span><br><span class="line">    <span class="variable">$connection</span>-&gt;send(json_encode(<span class="variable">$all_tables</span>));</span><br><span class="line">&#125;;</span><br><span class="line">// 运行worker</span><br><span class="line">Worker::runAll();</span><br><span class="line">具体MySQL/Connection用法</span><br><span class="line">// 初始化db连接</span><br><span class="line"><span class="variable">$db</span> = new \Workerman\MySQL\Connection(<span class="string">'host'</span>, <span class="string">'port'</span>, <span class="string">'user'</span>, <span class="string">'password'</span>, <span class="string">'db_name'</span>);</span><br><span class="line">// 获取所有数据</span><br><span class="line"><span class="variable">$db</span>-&gt;select(<span class="string">'ID,Sex'</span>)-&gt;from(<span class="string">'Persons'</span>)-&gt;<span class="built_in">where</span>(<span class="string">'sex= :sex AND ID = :id'</span>)-&gt;bindValues(array(<span class="string">'sex'</span>=&gt;<span class="string">'M'</span>, <span class="string">'id'</span> =&gt; 1))-&gt;query();</span><br><span class="line">//等价于</span><br><span class="line"><span class="variable">$db</span>-&gt;select(<span class="string">'ID,Sex'</span>)-&gt;from(<span class="string">'Persons'</span>)-&gt;<span class="built_in">where</span>(<span class="string">"sex= 'M' AND ID = 1"</span>)-&gt;query();</span><br><span class="line">//等价于</span><br><span class="line"><span class="variable">$db</span>-&gt;query(<span class="string">"SELECT ID,Sex FROM `Persons` WHERE sex='M' AND ID = 1"</span>);</span><br><span class="line">// 获取一行数据</span><br><span class="line"><span class="variable">$db</span>-&gt;select(<span class="string">'ID,Sex'</span>)-&gt;from(<span class="string">'Persons'</span>)-&gt;<span class="built_in">where</span>(<span class="string">'sex= :sex'</span>)-&gt;bindValues(array(<span class="string">'sex'</span>=&gt;<span class="string">'M'</span>))-&gt;row();</span><br><span class="line">//等价于</span><br><span class="line"><span class="variable">$db</span>-&gt;select(<span class="string">'ID,Sex'</span>)-&gt;from(<span class="string">'Persons'</span>)-&gt;<span class="built_in">where</span>(<span class="string">"sex= 'M' "</span>)-&gt;row();</span><br><span class="line">//等价于</span><br><span class="line"><span class="variable">$db</span>-&gt;row(<span class="string">"SELECT ID,Sex FROM `Persons` WHERE sex='M'"</span>);</span><br><span class="line">// 获取一列数据</span><br><span class="line"><span class="variable">$db</span>-&gt;select(<span class="string">'ID'</span>)-&gt;from(<span class="string">'Persons'</span>)-&gt;<span class="built_in">where</span>(<span class="string">'sex= :sex'</span>)-&gt;bindValues(array(<span class="string">'sex'</span>=&gt;<span class="string">'M'</span>))-&gt;column();</span><br><span class="line">//等价于</span><br><span class="line"><span class="variable">$db</span>-&gt;select(<span class="string">'ID'</span>)-&gt;from(<span class="string">'Persons'</span>)-&gt;<span class="built_in">where</span>(<span class="string">"sex= 'F' "</span>)-&gt;column();</span><br><span class="line">//等价于</span><br><span class="line"><span class="variable">$db</span>-&gt;column(<span class="string">"SELECT `ID` FROM `Persons` WHERE sex='M'"</span>);</span><br><span class="line">// 获取单个值</span><br><span class="line"><span class="variable">$db</span>-&gt;select(<span class="string">'ID'</span>)-&gt;from(<span class="string">'Persons'</span>)-&gt;<span class="built_in">where</span>(<span class="string">'sex= :sex'</span>)-&gt;bindValues(array(<span class="string">'sex'</span>=&gt;<span class="string">'M'</span>))-&gt;single();</span><br><span class="line">//等价于</span><br><span class="line"><span class="variable">$db</span>-&gt;select(<span class="string">'ID'</span>)-&gt;from(<span class="string">'Persons'</span>)-&gt;<span class="built_in">where</span>(<span class="string">"sex= 'F' "</span>)-&gt;single();</span><br><span class="line">//等价于</span><br><span class="line"><span class="variable">$db</span>-&gt;single(<span class="string">"SELECT ID FROM `Persons` WHERE sex='M'"</span>);</span><br><span class="line">// 复杂查询</span><br><span class="line"><span class="variable">$db</span>-&gt;select(<span class="string">'*'</span>)-&gt;from(<span class="string">'table1'</span>)-&gt;innerJoin(<span class="string">'table2'</span>,<span class="string">'table1.uid = table2.uid'</span>)-&gt;<span class="built_in">where</span>(<span class="string">'age &gt; :age'</span>)-&gt;groupBy(array(<span class="string">'aid'</span>))-&gt;having(<span class="string">'foo="foo"'</span>)-&gt;orderByASC/*orderByDESC*/(array(<span class="string">'did'</span>))</span><br><span class="line">-&gt;<span class="built_in">limit</span>(10)-&gt;offset(20)-&gt;bindValues(array(<span class="string">'age'</span> =&gt; 13));</span><br><span class="line">// 等价于</span><br><span class="line"><span class="variable">$db</span>-&gt;query(<span class="string">'SELECT * FROM `table1` INNER JOIN `table2` ON `table1`.`uid` = `table2`.`uid`</span></span><br><span class="line"><span class="string">WHERE age &gt; 13 GROUP BY aid HAVING foo="foo" ORDER BY did LIMIT 10 OFFSET 20'</span>);</span><br><span class="line">// 插入</span><br><span class="line"><span class="variable">$insert_id</span> = <span class="variable">$db</span>-&gt;insert(<span class="string">'Persons'</span>)-&gt;cols(array(</span><br><span class="line">    <span class="string">'Firstname'</span>=&gt;<span class="string">'abc'</span>,</span><br><span class="line">    <span class="string">'Lastname'</span>=&gt;<span class="string">'efg'</span>,</span><br><span class="line">    <span class="string">'Sex'</span>=&gt;<span class="string">'M'</span>,</span><br><span class="line">    <span class="string">'Age'</span>=&gt;13))-&gt;query();</span><br><span class="line">等价于</span><br><span class="line"><span class="variable">$insert_id</span> = <span class="variable">$db</span>-&gt;query(<span class="string">"INSERT INTO `Persons` ( `Firstname`,`Lastname`,`Sex`,`Age`)</span></span><br><span class="line"><span class="string">VALUES ( 'abc', 'efg', 'M', 13)"</span>);</span><br><span class="line">// 更新</span><br><span class="line"><span class="variable">$row_count</span> = <span class="variable">$db</span>-&gt;update(<span class="string">'Persons'</span>)-&gt;cols(array(<span class="string">'sex'</span>))-&gt;<span class="built_in">where</span>(<span class="string">'ID=1'</span>)</span><br><span class="line">-&gt;bindValue(<span class="string">'sex'</span>, <span class="string">'F'</span>)-&gt;query();</span><br><span class="line">// 等价于</span><br><span class="line"><span class="variable">$row_count</span> = <span class="variable">$db</span>-&gt;update(<span class="string">'Persons'</span>)-&gt;cols(array(<span class="string">'sex'</span>=&gt;<span class="string">'F'</span>))-&gt;<span class="built_in">where</span>(<span class="string">'ID=1'</span>)-&gt;query();</span><br><span class="line">// 等价于</span><br><span class="line"><span class="variable">$row_count</span> = <span class="variable">$db</span>-&gt;query(<span class="string">"UPDATE `Persons` SET `sex` = 'F' WHERE ID=1"</span>);</span><br><span class="line">// 删除</span><br><span class="line"><span class="variable">$row_count</span> = <span class="variable">$db</span>-&gt;delete(<span class="string">'Persons'</span>)-&gt;<span class="built_in">where</span>(<span class="string">'ID=9'</span>)-&gt;query();</span><br><span class="line">// 等价于</span><br><span class="line"><span class="variable">$row_count</span> = <span class="variable">$db</span>-&gt;query(<span class="string">"DELETE FROM `Persons` WHERE ID=9"</span>);</span><br><span class="line">// 事务</span><br><span class="line"><span class="variable">$db</span>-&gt;beginTrans();</span><br><span class="line">....</span><br><span class="line"><span class="variable">$db</span>-&gt;commitTrans(); // or <span class="variable">$db</span>-&gt;rollBackTrans();</span><br></pre></td></tr></table></figure></p><p>More info: <a href="http://doc.workerman.net/components/workerman-mysql.html" target="_blank" rel="noopener">GO</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;安装说明&quot;&gt;&lt;a href=&quot;#安装说明&quot; class=&quot;headerlink&quot; title=&quot;安装说明&quot;&gt;&lt;/a&gt;安装说明&lt;/h3&gt;&lt;p&gt;WorkerMan实际上就是一个PHP代码包，如果你的PHP环境已经装好，只需要把WorkerMan源代码或者demo下载下
      
    
    </summary>
    
      <category term="后端" scheme="http://140.143.243.43/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
      <category term="workerman" scheme="http://140.143.243.43/tags/workerman/"/>
    
  </entry>
  
  <entry>
    <title>Redis安装使用</title>
    <link href="http://140.143.243.43/2019/02/17/Redis%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/"/>
    <id>http://140.143.243.43/2019/02/17/Redis安装使用/</id>
    <published>2019-02-16T17:25:52.000Z</published>
    <updated>2019-02-16T18:05:56.815Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Linux-下安装"><a href="#Linux-下安装" class="headerlink" title="Linux 下安装"></a>Linux 下安装</h3><p>下载地址：<a href="http://redis.io/download" target="_blank" rel="noopener">http://redis.io/download</a> ,下载最新文档版本。<br>本教程使用的最新文档版本为 4.0.1，下载并安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.redis.io/releases/redis-4.0.1.tar.gz</span><br><span class="line">tar xzf redis-4.0.1.tar.gz</span><br><span class="line"><span class="built_in">cd</span> redis-4.0.1</span><br><span class="line">make</span><br></pre></td></tr></table></figure><p>make完后 redis-4.0.1目录下会出现编译后的redis服务程序redis-server,还有用于测试的客户端程序redis-cli,两个程序位于安装目录 src 目录下：<br>下面启动redis服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> src</span><br><span class="line">./redis-server</span><br><span class="line"><span class="comment">#注意这种方式启动redis 使用的是默认配置。也可以通过启动参数告诉redis使用指定配置文件使用下面命令启动。</span></span><br><span class="line"><span class="built_in">cd</span> src</span><br><span class="line">./redis-server redis.conf</span><br><span class="line"><span class="comment">#redis.conf是一个默认的配置文件。我们可以根据需要使用自己的配置文件。</span></span><br></pre></td></tr></table></figure><p>启动redis服务进程后，就可以使用测试客户端程序redis-cli和redis服务交互了。 比如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> src</span><br><span class="line">./redis-cli</span><br><span class="line">redis&gt; <span class="built_in">set</span> foo bar</span><br><span class="line">OK</span><br><span class="line">redis&gt; get foo</span><br><span class="line"><span class="string">"bar"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="http://www.runoob.com/redis/redis-install.html" target="_blank" rel="noopener">GO</a></p><h3 id="PHP-使用-Redis"><a href="#PHP-使用-Redis" class="headerlink" title="PHP 使用 Redis"></a>PHP 使用 Redis</h3><p>PHP安装redis扩展</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/phpredis/phpredis/archive/2.2.4.tar.gz</span><br><span class="line"><span class="built_in">cd</span> phpredis-2.2.7                      <span class="comment"># 进入 phpredis 目录</span></span><br><span class="line">/usr/<span class="built_in">local</span>/php/bin/phpize              <span class="comment"># php安装后的路径</span></span><br><span class="line">./configure --with-php-config=/usr/<span class="built_in">local</span>/php/bin/php-config</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="comment">#如果你是 PHP7 版本，则需要下载指定分支：</span></span><br><span class="line">git <span class="built_in">clone</span> -b php7 https://github.com/phpredis/phpredis.git</span><br></pre></td></tr></table></figure><p>修改php.ini文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /usr/<span class="built_in">local</span>/php/lib/php.ini</span><br><span class="line"><span class="comment">#增加如下内容:</span></span><br><span class="line">extension_dir = <span class="string">"/usr/local/php/lib/php/extensions/no-debug-zts-20090626"</span>（默认可以不加）</span><br><span class="line">extension=redis.so（必加）</span><br></pre></td></tr></table></figure><p>安装完成后重启php-fpm 或 apache。查看phpinfo信息，就能看到redis扩展。<br><img src="http://140.143.243.43/images/phpinfo.jpg" alt="phpinfo"></p><p>连接到 redis 服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    //连接本地的 Redis 服务</span><br><span class="line">   <span class="variable">$redis</span> = new Redis();</span><br><span class="line">   <span class="variable">$redis</span>-&gt;connect(<span class="string">'127.0.0.1'</span>, 6379);</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"Connection to server sucessfully"</span>;</span><br><span class="line">         //查看服务是否运行</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"Server is running: "</span> . <span class="variable">$redis</span>-&gt;ping();</span><br><span class="line">?&gt;</span><br><span class="line"><span class="comment">#执行脚本，输出结果为：</span></span><br><span class="line">Connection to server sucessfully</span><br><span class="line">Server is running: PONG</span><br></pre></td></tr></table></figure><p>Redis PHP String(字符串) 实例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   //连接本地的 Redis 服务</span><br><span class="line">   <span class="variable">$redis</span> = new Redis();</span><br><span class="line">   <span class="variable">$redis</span>-&gt;connect(<span class="string">'127.0.0.1'</span>, 6379);</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"Connection to server sucessfully"</span>;</span><br><span class="line">   //设置 redis 字符串数据</span><br><span class="line">   <span class="variable">$redis</span>-&gt;<span class="built_in">set</span>(<span class="string">"tutorial-name"</span>, <span class="string">"Redis tutorial"</span>);</span><br><span class="line">   // 获取存储的数据并输出</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"Stored string in redis:: "</span> . <span class="variable">$redis</span>-&gt;get(<span class="string">"tutorial-name"</span>);</span><br><span class="line">?&gt;</span><br><span class="line"><span class="comment">#执行脚本，输出结果为：</span></span><br><span class="line">Connection to server sucessfully</span><br><span class="line">Stored string <span class="keyword">in</span> redis:: Redis tutorial</span><br></pre></td></tr></table></figure><p>Redis PHP List(列表) 实例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   //连接本地的 Redis 服务</span><br><span class="line">   <span class="variable">$redis</span> = new Redis();</span><br><span class="line">   <span class="variable">$redis</span>-&gt;connect(<span class="string">'127.0.0.1'</span>, 6379);</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"Connection to server sucessfully"</span>;</span><br><span class="line">   //存储数据到列表中</span><br><span class="line">   <span class="variable">$redis</span>-&gt;lpush(<span class="string">"tutorial-list"</span>, <span class="string">"Redis"</span>);</span><br><span class="line">   <span class="variable">$redis</span>-&gt;lpush(<span class="string">"tutorial-list"</span>, <span class="string">"Mongodb"</span>);</span><br><span class="line">   <span class="variable">$redis</span>-&gt;lpush(<span class="string">"tutorial-list"</span>, <span class="string">"Mysql"</span>);</span><br><span class="line">   // 获取存储的数据并输出</span><br><span class="line">   <span class="variable">$arList</span> = <span class="variable">$redis</span>-&gt;lrange(<span class="string">"tutorial-list"</span>, 0 ,5);</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"Stored string in redis"</span>;</span><br><span class="line">   print_r(<span class="variable">$arList</span>);</span><br><span class="line">?&gt;</span><br><span class="line"><span class="comment">#执行脚本，输出结果为：</span></span><br><span class="line">Connection to server sucessfully</span><br><span class="line">Stored string <span class="keyword">in</span> redis</span><br><span class="line">Mysql</span><br><span class="line">Mongodb</span><br><span class="line">Redis</span><br></pre></td></tr></table></figure><p>Redis PHP Keys 实例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   //连接本地的 Redis 服务</span><br><span class="line">   <span class="variable">$redis</span> = new Redis();</span><br><span class="line">   <span class="variable">$redis</span>-&gt;connect(<span class="string">'127.0.0.1'</span>, 6379);</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"Connection to server sucessfully"</span>;</span><br><span class="line">   // 获取数据并输出</span><br><span class="line">   <span class="variable">$arList</span> = <span class="variable">$redis</span>-&gt;keys(<span class="string">"*"</span>);</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"Stored keys in redis:: "</span>;</span><br><span class="line">   print_r(<span class="variable">$arList</span>);</span><br><span class="line">?&gt;</span><br><span class="line"><span class="comment">#执行脚本，输出结果为：</span></span><br><span class="line">Connection to server sucessfully</span><br><span class="line">Stored string <span class="keyword">in</span> redis::</span><br><span class="line">tutorial-name</span><br><span class="line">tutorial-list</span><br></pre></td></tr></table></figure><p>More info: <a href="http://www.runoob.com/redis/redis-php.html" target="_blank" rel="noopener">GO</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Linux-下安装&quot;&gt;&lt;a href=&quot;#Linux-下安装&quot; class=&quot;headerlink&quot; title=&quot;Linux 下安装&quot;&gt;&lt;/a&gt;Linux 下安装&lt;/h3&gt;&lt;p&gt;下载地址：&lt;a href=&quot;http://redis.io/download&quot; ta
      
    
    </summary>
    
      <category term="后端" scheme="http://140.143.243.43/categories/%E5%90%8E%E7%AB%AF/"/>
    
    
      <category term="redis" scheme="http://140.143.243.43/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Linux上iptables防火墙的配置</title>
    <link href="http://140.143.243.43/2019/02/17/Linux%E4%B8%8Aiptables%E9%98%B2%E7%81%AB%E5%A2%99%E7%9A%84%E9%85%8D%E7%BD%AE/"/>
    <id>http://140.143.243.43/2019/02/17/Linux上iptables防火墙的配置/</id>
    <published>2019-02-16T16:49:15.000Z</published>
    <updated>2019-02-16T17:21:14.334Z</updated>
    
    <content type="html"><![CDATA[<h3 id="安装iptables防火墙"><a href="#安装iptables防火墙" class="headerlink" title="安装iptables防火墙"></a>安装iptables防火墙</h3><p>如果没有安装iptables需要先安装，CentOS执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install iptables</span><br></pre></td></tr></table></figure><p>Debian/Ubuntu执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install iptables</span><br></pre></td></tr></table></figure><h3 id="清除已有iptables规则"><a href="#清除已有iptables规则" class="headerlink" title="清除已有iptables规则"></a>清除已有iptables规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br><span class="line">iptables -X</span><br><span class="line">iptables -Z</span><br></pre></td></tr></table></figure><h3 id="开放指定的端口"><a href="#开放指定的端口" class="headerlink" title="开放指定的端口"></a>开放指定的端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">-A和-I参数分别为添加到规则末尾和规则最前面。</span><br><span class="line"><span class="comment">#允许本地回环接口(即运行本机访问本机)</span></span><br><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br><span class="line"><span class="comment"># 允许已建立的或相关连的通行</span></span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line"><span class="comment">#允许所有本机向外的访问</span></span><br><span class="line">iptables -A OUTPUT -j ACCEPT</span><br><span class="line"><span class="comment"># 允许访问22端口</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line"><span class="comment">#允许访问80端口</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line"><span class="comment">#允许访问443端口</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 443 -j ACCEPT</span><br><span class="line"><span class="comment">#允许FTP服务的21和20端口</span></span><br><span class="line">iptables -A INPUT -p tcp --dport 21 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 20 -j ACCEPT</span><br><span class="line"><span class="comment">#如果有其他端口的话，规则也类似，稍微修改上述语句就行</span></span><br><span class="line"><span class="comment">#允许ping</span></span><br><span class="line">iptables -A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT</span><br><span class="line"><span class="comment">#禁止其他未允许的规则访问</span></span><br><span class="line">iptables -A INPUT -j REJECT  <span class="comment">#（注意：如果22端口未加入允许规则，SSH链接会直接断开。）</span></span><br><span class="line">iptables -A FORWARD -j REJECT</span><br></pre></td></tr></table></figure><h3 id="屏蔽IP"><a href="#屏蔽IP" class="headerlink" title="屏蔽IP"></a>屏蔽IP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#如果只是想屏蔽IP的话“3、开放指定的端口”可以直接跳过。</span></span><br><span class="line"><span class="comment">#屏蔽单个IP的命令是</span></span><br><span class="line">iptables -I INPUT -s 123.45.6.7 -j DROP</span><br><span class="line"><span class="comment">#封整个段即从123.0.0.1到123.255.255.254的命令</span></span><br><span class="line">iptables -I INPUT -s 123.0.0.0/8 -j DROP</span><br><span class="line"><span class="comment">#封IP段即从123.45.0.1到123.45.255.254的命令</span></span><br><span class="line">iptables -I INPUT -s 124.45.0.0/16 -j DROP</span><br><span class="line"><span class="comment">#封IP段即从123.45.6.1到123.45.6.254的命令是</span></span><br><span class="line">iptables -I INPUT -s 123.45.6.0/24 -j DROP</span><br></pre></td></tr></table></figure><h3 id="查看已添加的iptables规则"><a href="#查看已添加的iptables规则" class="headerlink" title="查看已添加的iptables规则"></a>查看已添加的iptables规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -L -n</span><br><span class="line"><span class="comment">#v：显示详细信息，包括每条规则的匹配包数量和匹配字节数</span></span><br><span class="line"><span class="comment">#x：在 v 的基础上，禁止自动单位换算（K、M） vps侦探</span></span><br><span class="line"><span class="comment">#n：只显示IP地址和端口号，不将ip解析为域名</span></span><br></pre></td></tr></table></figure><h3 id="删除已添加的iptables规则"><a href="#删除已添加的iptables规则" class="headerlink" title="删除已添加的iptables规则"></a>删除已添加的iptables规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将所有iptables以序号标记显示，执行：</span></span><br><span class="line">iptables -L -n --line-numbers</span><br><span class="line"><span class="comment">#比如要删除INPUT里序号为8的规则，执行：</span></span><br><span class="line">iptables -D INPUT 8</span><br></pre></td></tr></table></figure><h3 id="iptables的开机启动及规则保存"><a href="#iptables的开机启动及规则保存" class="headerlink" title="iptables的开机启动及规则保存"></a>iptables的开机启动及规则保存</h3><p>CentOS上可能会存在安装好iptables后，iptables并不开机自启动，要加入开机启动，可以执行一下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --level 345 iptables on</span><br></pre></td></tr></table></figure><p>修改iptables配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/iptables</span><br><span class="line"><span class="comment">#保存规则CentOS上可以执行</span></span><br><span class="line">service iptables save </span><br><span class="line"><span class="comment">#另外更需要注意的是Debian/Ubuntu上iptables是不会保存规则的</span></span><br><span class="line"><span class="comment">#需要按如下步骤进行，让网卡关闭是保存iptables规则，启动时加载iptables规则：</span></span><br><span class="line"><span class="comment">#创建/etc/network/if-post-down.d/iptables 文件，添加如下内容：</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">iptables-save &gt; /etc/iptables.rules</span><br><span class="line"><span class="comment">#执行：chmod +x /etc/network/if-post-down.d/iptables 添加执行权限。</span></span><br><span class="line"><span class="comment">#创建/etc/network/if-pre-up.d/iptables 文件，添加如下内容：</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">iptables-restore &lt; /etc/iptables.rules</span><br><span class="line"><span class="comment">#执行：chmod +x /etc/network/if-pre-up.d/iptables 添加执行权限。</span></span><br></pre></td></tr></table></figure><h3 id="CentOS切换为iptables防火墙"><a href="#CentOS切换为iptables防火墙" class="headerlink" title="CentOS切换为iptables防火墙"></a>CentOS切换为iptables防火墙</h3><p>切换到iptables首先应该关掉默认的firewalld，然后安装iptables服务。</p><p>关闭firewall：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service firewalld stop</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service <span class="comment">#禁止firewall开机启动</span></span><br></pre></td></tr></table></figure><p>安装iptables防火墙服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install iptables-services <span class="comment">#安装</span></span><br></pre></td></tr></table></figure><p>编辑iptables防火墙配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysconfig/iptables <span class="comment">#编辑防火墙配置文件</span></span><br><span class="line">service iptables restart <span class="comment">#开启 </span></span><br><span class="line">systemctl <span class="built_in">enable</span> iptables.service <span class="comment">#设置防火墙开机启动</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;安装iptables防火墙&quot;&gt;&lt;a href=&quot;#安装iptables防火墙&quot; class=&quot;headerlink&quot; title=&quot;安装iptables防火墙&quot;&gt;&lt;/a&gt;安装iptables防火墙&lt;/h3&gt;&lt;p&gt;如果没有安装iptables需要先安装，CentOS
      
    
    </summary>
    
      <category term="服务器" scheme="http://140.143.243.43/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
    
      <category term="linux" scheme="http://140.143.243.43/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>Centos7部署LNMP+SSL服务器</title>
    <link href="http://140.143.243.43/2019/02/16/Centos7%E9%83%A8%E7%BD%B2LNMP-SSL%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    <id>http://140.143.243.43/2019/02/16/Centos7部署LNMP-SSL服务器/</id>
    <published>2019-02-16T15:32:46.000Z</published>
    <updated>2019-02-16T16:40:16.703Z</updated>
    
    <content type="html"><![CDATA[<h3 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/"</span> /etc/selinux/config</span><br><span class="line">setenforce 0</span><br></pre></td></tr></table></figure><p>防火墙配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --add-port=80/tcp</span><br><span class="line">firewall-cmd --permanent --add-service=http</span><br><span class="line">firewall-cmd --permanent --add-service=https</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><h3 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h3><p>安装nginx rpm包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</span><br></pre></td></tr></table></figure><p>正式安装nginx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nginx</span><br></pre></td></tr></table></figure><p>重启nginx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure><p>设置开机自启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> nginx</span><br></pre></td></tr></table></figure><h3 id="安装php7"><a href="#安装php7" class="headerlink" title="安装php7"></a>安装php7</h3><p>安装php-fpm的依赖</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install net-tools gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel git gcc wget -y</span><br></pre></td></tr></table></figure><p>安装epel-release</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install epel-release</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span><br></pre></td></tr></table></figure><p>正式安装php7</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install php71w-fpm php71w-cli php71w-gd php71w-mcrypt php71w-mysql php71w-pear php71w-xml php71w-mbstring php71w-pdo php71w-json php71w-pecl-apcu php71w-pecl-apcu-devel</span><br></pre></td></tr></table></figure><p>查看php版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -v</span><br></pre></td></tr></table></figure><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>nginx配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改nginx用户，在第 8 行和第 10行，user 和 group 赋值为 nginx。</span></span><br><span class="line">vim /etc/php-fpm.d/www.conf</span><br><span class="line">user = nginx</span><br><span class="line">group = nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#在第 22 行，确保 php-fpm 运行在指定端口。</span></span><br><span class="line">listen = 127.0.0.1:9000</span><br><span class="line"></span><br><span class="line"><span class="comment">#取消第 366-370 行的注释，启用 php-fpm 的系统环境变量。</span></span><br><span class="line">env[HOSTNAME] = <span class="variable">$HOSTNAME</span></span><br><span class="line">env[PATH] = /usr/<span class="built_in">local</span>/bin:/usr/bin:/bin</span><br><span class="line">env[TMP] = /tmp</span><br><span class="line">env[TMPDIR] = /tmp</span><br><span class="line">env[TEMP] = /tmp</span><br></pre></td></tr></table></figure><p>php配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#新建php缓存文件夹</span></span><br><span class="line">mkdir -p /var/lib/php/session</span><br><span class="line"><span class="comment">#设置文件夹及子目录文件所属用户组</span></span><br><span class="line">chown nginx:nginx -R /var/lib/php/session/</span><br></pre></td></tr></table></figure><p>重启php、nginx,并设置开机自启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start php-fpm</span><br><span class="line">sudo systemctl start nginx</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> php-fpm</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> nginx</span><br></pre></td></tr></table></figure><h3 id="安装mariadb"><a href="#安装mariadb" class="headerlink" title="安装mariadb"></a>安装mariadb</h3><p>安装mariadb</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mariadb mariadb-server</span><br></pre></td></tr></table></figure><p>启动并设置mariadb开机自启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mariadb</span><br><span class="line">systemctl <span class="built_in">enable</span> mariadb</span><br></pre></td></tr></table></figure><h3 id="配置SSL"><a href="#配置SSL" class="headerlink" title="配置SSL"></a>配置SSL</h3><p>创建SSL证书文件夹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/nginx/cert/</span><br></pre></td></tr></table></figure><p>根据私钥pri_key.pem生产一个新的证书请求文件并保存</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -x509 -days 365 -nodes -out /etc/nginx/cert/xxx.crt -keyout /etc/nginx/cert/xxx.key</span><br></pre></td></tr></table></figure><p>配置证书目录权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 700 /etc/nginx/cert</span><br><span class="line">chmod 600 /etc/nginx/cert/*</span><br></pre></td></tr></table></figure><p>配置网站目录所属用户组</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/share/nginx/html/</span><br><span class="line">chown nginx:nginx -R xxx/</span><br></pre></td></tr></table></figure><p>配置虚拟主机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/nginx/conf.d/</span><br><span class="line">vim xxx.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name www.nbdeli.com;</span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$server_name</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 443;</span><br><span class="line">    server_name www.nbdeli.com;</span><br><span class="line">    ssl on;</span><br><span class="line">    ssl_certificate /etc/nginx/cert/nbdeli.com.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/cert/nbdeli.com.key;</span><br><span class="line">    add_header Strict-Transport-Security <span class="string">"max-age=15768000;</span></span><br><span class="line"><span class="string">    includeSubDomains; preload;"</span>;</span><br><span class="line">    add_header X-Content-Type-Options nosniff;</span><br><span class="line">    add_header X-Frame-Options <span class="string">"SAMEORIGIN"</span>;</span><br><span class="line">    add_header X-XSS-Protection <span class="string">"1; mode=block"</span>;</span><br><span class="line">    add_header X-Robots-Tag none;</span><br><span class="line">    add_header X-Download-Options noopen;</span><br><span class="line">    add_header X-Permitted-Cross-Domain-Policies none;</span><br><span class="line">    access_log  /home/wwwlog/<span class="variable">$server_name</span>.access.log  main;</span><br><span class="line">    location = /robots.txt &#123;</span><br><span class="line">       allow all;</span><br><span class="line">       log_not_found off;</span><br><span class="line">       access_log off;</span><br><span class="line">    &#125;</span><br><span class="line">    location = /.well-known/carddav &#123;</span><br><span class="line">      <span class="built_in">return</span> 301 <span class="variable">$scheme</span>://<span class="variable">$host</span>/remote.php/dav;</span><br><span class="line">    &#125;</span><br><span class="line">    location = /.well-known/caldav &#123;</span><br><span class="line">      <span class="built_in">return</span> 301 <span class="variable">$scheme</span>://<span class="variable">$host</span>/remote.php/dav;</span><br><span class="line">    &#125;</span><br><span class="line">    client_max_body_size 512M;</span><br><span class="line">    fastcgi_buffers 64 4K;</span><br><span class="line">    gzip off;</span><br><span class="line">    error_page 403 /core/templates/403.php;</span><br><span class="line">    error_page 404 /core/templates/404.php;</span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /home/wwwroot/<span class="variable">$server_name</span>;</span><br><span class="line">        index  index.html index.htm index.php default.php;</span><br><span class="line">    &#125;</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        fastcgi_index  index.php;</span><br><span class="line">        fastcgi_param  SCRIPT_FILENAME  /home/wwwroot/<span class="variable">$server_name</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        include        fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)/ &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ ^/(?:\.|autotest|occ|issue|indie|db_|console) &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ ^/(?:index|remote|public|cron|core/ajax/update|status|ocs/v[12]|updater/.+|ocs-provider/.+|core/templates/40[34])\.php(?:$|/) &#123;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">        fastcgi_split_path_info ^(.+\.php)(/.*)$;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        fastcgi_param PATH_INFO <span class="variable">$fastcgi_path_info</span>;</span><br><span class="line">        fastcgi_param HTTPS on;</span><br><span class="line">        fastcgi_param modHeadersAvailable <span class="literal">true</span>;</span><br><span class="line">        fastcgi_param front_controller_active <span class="literal">true</span>;</span><br><span class="line">        fastcgi_intercept_errors on;</span><br><span class="line">        fastcgi_request_buffering off;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ ^/(?:updater|ocs-provider)(?:$|/) &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span>/ =404;</span><br><span class="line">        index index.php;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~* \.(?:css|js)$ &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> /index.php<span class="variable">$uri</span><span class="variable">$is_args</span><span class="variable">$args</span>;</span><br><span class="line">        add_header Cache-Control <span class="string">"public, max-age=7200"</span>;</span><br><span class="line">        add_header Strict-Transport-Security <span class="string">"max-age=15768000;</span></span><br><span class="line"><span class="string">        includeSubDomains; preload;"</span>;</span><br><span class="line">        add_header X-Content-Type-Options nosniff;</span><br><span class="line">        add_header X-Frame-Options <span class="string">"SAMEORIGIN"</span>;</span><br><span class="line">        add_header X-XSS-Protection <span class="string">"1; mode=block"</span>;</span><br><span class="line">        add_header X-Robots-Tag none;</span><br><span class="line">        add_header X-Download-Options noopen;</span><br><span class="line">        add_header X-Permitted-Cross-Domain-Policies none;</span><br><span class="line">        access_log off;</span><br><span class="line">     &#125;</span><br><span class="line">     location ~* \.(?:svg|gif|png|html|ttf|woff|ico|jpg|jpeg)$ &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> /index.php<span class="variable">$uri</span><span class="variable">$is_args</span><span class="variable">$args</span>;</span><br><span class="line">        access_log off;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试nginx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br></pre></td></tr></table></figure><p>配置完nginx,记得重启nginx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart nginx</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;关闭防火墙&quot;&gt;&lt;a href=&quot;#关闭防火墙&quot; class=&quot;headerlink&quot; title=&quot;关闭防火墙&quot;&gt;&lt;/a&gt;关闭防火墙&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;
      
    
    </summary>
    
      <category term="服务器" scheme="http://140.143.243.43/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
    
      <category term="linux" scheme="http://140.143.243.43/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://140.143.243.43/2019/02/15/hello-world/"/>
    <id>http://140.143.243.43/2019/02/15/hello-world/</id>
    <published>2019-02-14T18:17:21.550Z</published>
    <updated>2019-02-14T18:17:21.550Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>myBlog</title>
    <link href="http://140.143.243.43/2019/02/14/myBlog/"/>
    <id>http://140.143.243.43/2019/02/14/myBlog/</id>
    <published>2019-02-14T14:24:10.000Z</published>
    <updated>2019-02-16T15:19:31.144Z</updated>
    
    <summary type="html">
    
    </summary>
    
    
      <category term="example" scheme="http://140.143.243.43/tags/example/"/>
    
  </entry>
  
</feed>
